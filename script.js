const book = {
  id: "an-tu-demo",
  title: "    An Tư",
  author: "Nguyễn Huy Tưởng",
  chapters: [
    {
      id: "an-tu",
      title: "An Tư",
      subtitle: "    Chương V",
      contextNote: "",
      paragraphs: [
        "Đây đã đến nơi sa lệ và u nhã nhất trong các cung điện nhà Trần. An Tư bước qua bực cửa Thái Thanh, mở vào ao Ngoạn Thiền, trèo lên lầu Lâm Ba, rồi tiến vào cung Cảnh Linh là nơi Thoát Hoan đóng. Ở đây vườn hoa, cây cảnh, cầu nước, lầu đài, cùng hòa hợp để vẽ nên một cảnh không kém Bồng Lai, một nơi tuyệt mỹ đến nỗi cảnh trí ở đây trong tưởng tượng của dân gian đã thành một cói hoang đường.",
        "Cung Cảnh Linh là phần chính trong cảnh tráng lệ này lại là nơi đẹp nhất, sang trọng nhất. Kiến trúc ở ngoài đã nhẹ nhàng trang nhã, trong cung lại bày ra một cảnh huy hoàng. Cột vàng sàn tía, sáng soi gương được, bước đi trên thảm gấm, tường có treo những bức thêu quý hay những bức họa tươi. Bình vàng bình ngọc, hay bình sứ đẹp để cắm những kỳ hoa dị thảo. Toàn thể rộng rãi, sáng sủa, kiểu cách, phảng phất một vẻ gì đài các, trang nghiêm, mà vẫn vui vầy ấm cúng.",
        "Trong cung khi ấy nến trắng đốt có hàng trăm cây: trong ánh sáng tưng bừng của nến, những vàng ngọc chảy lóng lánh rất vui. Hoa ngoài vườn và hoa trong cung tỏa một mùi thơm kín đáo.",
        "A Thích dừng bước ngoài thềm và bảo An Tư:",
        "— Công chúa một mình vào. Tôi đi đây.",
        "Nói xong đi mất. An Tư còn đang ngơ ngác, thì cửa ngoài đã đóng lại sau lưng nàng, nàng bị giam trong cung đầy ánh sáng. Nàng đứng nguyên một chỗ. Ôi! Trước kia nàng vào đây không ai cấm đoán, sao bây giờ nàng bỗng thấy rợn trong người. Không có ai, duy chiếc đỉnh trầm vàng vẫn bốc khói lên ngun ngút giữa cung. Nàng biết có ai nhìn, nhưng không biết đứng ở đâu. Chợt có tiếng cười khanh khách và sau bình phong, một người bước ra, ăn mặc khinh phục rất lịch sự. Mũ hoa, bào đỏ, đai ngọc, trông lấp la lấp lánh những vàng bạc, chân cũng đi văn hài, mỗi bên thêu một con kỳ lân đớp viên ngọc sáng ở mũi hài. Nàng nhận rõ Trấn Nam Vương Thoát Hoan, Thái Tử nhà Nguyên, kẻ thù số một của dân Việt, người tàn ác đã gieo bao nhiêu thảm họa, giết hại bao nhiêu sinh linh, mà ai ai cũng hình dung như một viên tướng hung tợn, mắt to, râu rậm, thân thể cao lớn, kỳ thực chỉ là một người tầm thước, đầu lớn, to ngang, trạc ba mươi tuổi, mỗi tai đeo lủng lẳng, theo tục Mông Cổ, một viên ngọc quý, một mí mắt hơi nhỏ, lông mày rậm, môi dày, dáng đi có vẻ nhanh nhẹn và mạnh mẽ. Hoan xì xồ, vẫy tay gọi nàng lại. An Tư vẫn không nhúc nhích, hai hàng lệ rỏ xuống ròng ròng. Hoan sấn một bước thì nàng lùi một bước, Hoan đi nhanh thì nàng lùi nhanh, đi chậm thì nàng lùi chậm, chợt vô ý thế nào, nàng chạm vào một cái đôn cao và cả một bình sứ lớn đỏ xuống vỡ tan ra từng mảnh.",
      ],
      imageHints: [
        {
          startText: "một viên tướng hung tợn",
          endText: "môi dày",
          title: "Viên tướng Thoát Hoan",
          description: "Hình ảnh minh họa mô tả Thoát Hoan",
          imageUrl: "https://media.discordapp.net/attachments/1360290814399484107/1461024056332779623/thoat-hoan-cong-chua-an-tu-16813817258811518161047.png?ex=69690c2f&is=6967baaf&hm=d553bdaea57df5fe70484358e24f068ea8ba9ee4720c37174c0fffef368a2051&=&format=webp&quality=lossless",
        },
        {
          startText: "An Tư",
          endText: "An Tư",
          title: "Công chúa An Tư",
          description: "Cước chú về công chúa An Tư",
          textContent: "Trong bản Ngọc phả về Công chúa Quỳnh Trân có viết: \"Năm Ất Dậu, giặc Nguyên do Ô Mã Nhi chỉ huy phạm vào Vân Đồn, Vạn Kiếp. Vua phải chạy vào Nghệ An. Triều đình bàn nhau định gả nàng cho tướng giặc để cầu thân. Nàng cự tuyệt, vua thương lại cho về chùa, rồi gả công chúa An Tư cho Thoát Hoan. [...]\".\n\nĐại Việt sử ký toàn thư chép rằng: \"Tháng 2 năm Thiệu Bảo thứ 7 (1285) vua sai người đưa công chúa An Tư (em gái út vua Trần Thánh Tông) đến cho Thoát Hoan là muốn làm thư dãn loạn nước vậy\".\n\nĐến Việt sử tiêu án của Ngô Thì Sĩ chỉ ghi: \"Thoát Hoan lên sông Nhĩ Hà, cột liền bè vào làm cầu cho quân qua sông. Quân ta theo hai bên sông lập đồn để cự lại, không được. Ngày đã về chiều, quân giặc qua được sông vào kinh thành, vua sai đưa Công chúa An Tư cho chúng, để thư nạn cho nước\".",
        },
        {
          startText: "lầu Lâm Ba",
          endText: "lầu Lâm Ba",
          title: "Lầu Lâm Ba",
          description: "Năm 2025, ban nhạc The Flob đã cho ra mắt bài hát \"lầu Lâm Ba\" để kể lại câu chuyện cuộc đời của công chúa An Tư",
          videoUrl: "https://www.youtube.com/embed/1WtEJbHUE8M",
        },
      ],
      mediaHints: [],
    },
  ],
};

let currentChapterId = book.chapters[0].id;
let currentSearchTerm = "";
let currentView = "home";

const searchInput = document.getElementById("searchInput");
const chapterContentEl = document.getElementById("chapterContent");
const searchResultInfoEl = document.getElementById("searchResultInfo");

const videoOverlayEl = document.getElementById("videoOverlay");
const videoTitleEl = document.getElementById("videoTitle");
const videoDescEl = document.getElementById("videoDescription");
const videoFrameEl = document.getElementById("videoFrame");
const closeVideoBtn = document.getElementById("closeVideoBtn");
const imageOverlayEl = document.getElementById("imageOverlay");
const imageTitleEl = document.getElementById("imageTitle");
const imageDescEl = document.getElementById("imageDescription");
const imageContentEl = document.getElementById("imageContent");
const imageTextContentEl = document.getElementById("imageTextContent");
const closeImageBtn = document.getElementById("closeImageBtn");
const navItems = document.querySelectorAll(".nav-item");
const tocSidebarEl = document.getElementById("tocSidebar");
const chapterSidebarEl = document.getElementById("chapterSidebar");
const tocToggleBtn = document.getElementById("tocToggleBtn");
const sidebarToggleBtn = document.getElementById("sidebarToggleBtn");
const sidebarCloseBtn = document.getElementById("sidebarCloseBtn");
const textContextMenu = document.getElementById("textContextMenu");
const noteDialog = document.getElementById("noteDialog");
const noteSelectedTextEl = document.getElementById("noteSelectedText");
const noteTextInput = document.getElementById("noteTextInput");
const saveNoteBtn = document.getElementById("saveNoteBtn");
const cancelNoteBtn = document.getElementById("cancelNoteBtn");
const closeNoteBtn = document.getElementById("closeNoteBtn");
const highlightsListEl = document.getElementById("highlightsList");
const bookmarksListEl = document.getElementById("bookmarksList");
const notesListEl = document.getElementById("notesList");
const sidebarNoteInput = document.getElementById("sidebarNoteInput");
const addSidebarNoteBtn = document.getElementById("addSidebarNoteBtn");

// Display settings elements
const toggleContextNotesEl = document.getElementById("toggleContextNotes");
const toggleMediaHintsEl = document.getElementById("toggleMediaHints");

const THEME_STORAGE_KEY = "historiart-theme";
const HIGHLIGHTS_STORAGE_KEY = "historiart-highlights";
const BOOKMARKS_STORAGE_KEY = "historiart-bookmarks";
const NOTES_STORAGE_KEY = "historiart-notes";
const DISPLAY_SETTINGS_KEY = "historiart-display-settings";

let highlights = JSON.parse(localStorage.getItem(HIGHLIGHTS_STORAGE_KEY) || "[]");
let bookmarks = JSON.parse(localStorage.getItem(BOOKMARKS_STORAGE_KEY) || "[]");
let notes = JSON.parse(localStorage.getItem(NOTES_STORAGE_KEY) || "[]");

let selectedText = null;
let selectedRange = null;
let isConfirmDialogOpen = false;

function normalizeText(text) {
  return text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

function renderToc() {
  if (!chapterSidebarEl) return;
  chapterSidebarEl.innerHTML = "";
  const term = normalizeText(currentSearchTerm.trim());

  book.chapters.forEach((chapter) => {
    const button = document.createElement("button");
    button.className = "toc-button";
    if (chapter.id === currentChapterId) {
      button.classList.add("active");
    }

    const titleEl = document.createElement("span");
    titleEl.className = "chapter-title";
    titleEl.textContent = chapter.title;

    const subtitleEl = document.createElement("span");
    subtitleEl.className = "chapter-subtitle";
    subtitleEl.textContent = chapter.subtitle;

    if (term) {
      const inTitle = normalizeText(chapter.title).includes(term);
      const inSubtitle = normalizeText(chapter.subtitle).includes(term);
      const inParagraph = chapter.paragraphs.some((p) =>
        normalizeText(p).includes(term)
      );
      if (!inTitle && !inSubtitle && !inParagraph) {
        button.style.opacity = "0.35";
      }
    }

    button.appendChild(titleEl);
    button.appendChild(subtitleEl);
    button.addEventListener("click", () => {
      if (chapter.id === currentChapterId) return;
      currentChapterId = chapter.id;
      renderToc();
      renderChapter();
    });

    chapterSidebarEl.appendChild(button);
  });
}

function highlightMatches(text, term) {
  if (!term) return text;

  const safeTerm = term.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
  const regex = new RegExp(safeTerm, "gi");
  return text.replace(regex, (match) => `<span class="highlight-search">${match}</span>`);
}

function renderChapter() {
  const chapter = book.chapters.find((c) => c.id === currentChapterId);
  if (!chapter) return;

  const term = currentSearchTerm.trim();
  let matchesCount = 0;
  
  const currentChapterHighlights = currentView === "book" 
    ? highlights.filter((h) => h.chapterId === currentChapterId)
    : [];

  const headerHtml = `
    <header class="chapter-header">
      <h2 class="chapter-header-title">${chapter.title}</h2>
      <p class="chapter-header-subtitle">${chapter.subtitle}</p>
      <p class="chapter-header-author">    Tác giả: ${book.author}</p>
    </header>
  `;

  const contextHtml = chapter.contextNote
    ? `<div class="context-note">${chapter.contextNote}</div>`
    : "";

  const paragraphsHtml = chapter.paragraphs
    .map((p, index) => {
      let processed = p;
      
      // Xử lý imageHints TRƯỚC các highlight khác để đảm bảo tìm được text gốc
      if (chapter.imageHints && chapter.imageHints.length > 0) {
        chapter.imageHints.forEach((imageHint, hintIndex) => {
          // Chỉ xử lý nếu startText và endText giống nhau (đánh dấu một từ/cụm từ)
          if (imageHint.startText === imageHint.endText) {
            const safeText = imageHint.startText.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
            const regex = new RegExp(`(${safeText})`, "g");
            processed = processed.replace(regex, `<span class="highlight-image" data-hint-index="${hintIndex}" data-chapter-id="${chapter.id}">$1</span>`);
          } else {
            // Xử lý trường hợp startText và endText khác nhau (đánh dấu một đoạn)
            const searchStart = processed.indexOf(imageHint.startText);
            const searchEnd = processed.indexOf(imageHint.endText);
            if (searchStart !== -1 && searchEnd !== -1 && searchEnd > searchStart) {
              const beforeText = processed.substring(0, searchStart);
              const highlightText = processed.substring(searchStart, searchEnd + imageHint.endText.length);
              const afterText = processed.substring(searchEnd + imageHint.endText.length);
              processed = `${beforeText}<span class="highlight-image" data-hint-index="${hintIndex}" data-chapter-id="${chapter.id}">${highlightText}</span>${afterText}`;
            }
          }
        });
      }
      
      if (currentChapterHighlights.length > 0) {
        currentChapterHighlights.forEach((h) => {
          if (processed.includes(h.fullText) && !processed.includes(`data-highlight-id="${h.id}"`)) {
            const safeText = h.fullText.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
            const regex = new RegExp(`(${safeText})`, "g");
            processed = processed.replace(regex, `<mark class="user-highlight" data-highlight-id="${h.id}">$1</mark>`);
          }
        });
      }
      
      if (term) {
        const before = processed;
        processed = highlightMatches(processed, term);
        if (processed !== before) {
          matchesCount += (processed.match(/highlight-search/g) || []).length;
        }
      }

      const mediaHint = chapter.mediaHints.find(
        (m) => m.paragraphIndex === index
      );

      let mediaHtml = "";
      if (mediaHint) {
        mediaHtml = `
          <div>
            <button class="media-button" data-chapter="${chapter.id}" data-paragraph="${index}">
              ▶
              <span>Xem clip minh hoạ</span>
            </button>
            <span class="media-hint">
              <span class="media-hint-dot"></span>
              Có video giúp bạn hình dung rõ hơn không khí đoạn này
            </span>
          </div>
        `;
      }
      
      return `<p>${processed}${mediaHtml}</p>`;
    })
    .join("");

  chapterContentEl.innerHTML = `
    ${headerHtml}
    ${contextHtml}
    <div class="chapter-body">
      ${paragraphsHtml}
    </div>
  `;

  if (!term) {
    searchResultInfoEl.textContent = "Nhập từ khoá để lọc nhanh nội dung.";
  } else {
    if (matchesCount > 0) {
      searchResultInfoEl.textContent = `Tìm thấy khoảng ${matchesCount} vị trí khớp trong chương này.`;
    } else {
      searchResultInfoEl.textContent =
        "Không thấy từ khoá trong chương này. Thử chọn chương khác ở mục lục bên trái.";
    }
  }

  attachMediaHandlers();
  attachImageHandlers();
  if (currentView === "book") {
    attachTextSelectionHandlers();
    renderSidebarItems();
  } else {
    if (textContextMenu) {
      hideContextMenu();
    }
  }

  // Apply display settings after rendering
  applyDisplaySettings();

  // Attach handlers for image highlights
  attachImageHandlers();
}

function renderHome() {
  currentView = "home";
  setTocSidebar(false);
  setTocToggleVisible(false);
  setSidebarToggleVisible(false);
  searchResultInfoEl.textContent = "Historiart – ebook đa giác quan về tác phẩm Việt Nam.";
  chapterContentEl.innerHTML = `
    <header class="chapter-header">
      <h2 class="chapter-header-title">Chào mừng đến với Historiart</h2>
      <p class="chapter-header-subtitle">Ebook đa giác quan cho tác phẩm Việt Nam</p>
    </header>
    <div class="chapter-body">
      <p>
        Historiart giúp bạn đọc tác phẩm Việt Nam với trải nghiệm đa giác quan: chữ, âm thanh,
        và clip minh hoạ cho những đoạn khó hình dung.
      </p>
      <p>
        • Vào <strong>Tìm sách</strong> để chọn sách.<br />
        • Nhấn <strong>"Xem clip minh hoạ"</strong> khi xuất hiện.<br />
        • Mở <strong>Cài đặt</strong> để chuyển Sáng/Tối.
      </p>
    </div>
  `;
}

function renderBrowse() {
  currentView = "browse";
  setTocSidebar(false);
  setTocToggleVisible(false);
  setSidebarToggleVisible(false);
  searchResultInfoEl.textContent = "Chọn sách để đọc.";
  chapterContentEl.innerHTML = `
    <header class="chapter-header">
      <h2 class="chapter-header-title">Tìm sách</h2>
      <p class="chapter-header-subtitle">Duyệt theo sách demo hiện có</p>
    </header>
    <div class="chapter-body browse-body">
      <div class="book-card">
        <div>
          <div class="book-card-title">An Tư</div>
          <div class="book-card-meta">Tác giả: Nguyễn Huy Tưởng · Thể loại: Tiểu thuyết lịch sử</div>
          <p class="book-card-desc">
            Trích từ tiểu thuyết "An Tư" - câu chuyện về công chúa An Tư bị lịch sử lãng quên. Click vào đoạn được highlight để xem ảnh minh hoạ.
          </p>
        </div>
        <button class="book-card-button" id="openDemoBook">Mở sách</button>
      </div>
    </div>
  `;

  const openBtn = document.getElementById("openDemoBook");
  if (openBtn) {
    openBtn.addEventListener("click", () => {
      renderBook();
    });
  }
}

function renderBook() {
  currentView = "book";
  setTocToggleVisible(false);
  setTocSidebar(false);
  setSidebarToggleVisible(true);
  renderToc();
  renderChapter();
}

function renderAuth() {
  currentView = "auth";
  setTocSidebar(false);
  setTocToggleVisible(false);
  setSidebarToggleVisible(false);
  searchResultInfoEl.textContent = "Đăng nhập hoặc tạo tài khoản mới (demo, chưa kết nối server).";
  chapterContentEl.innerHTML = `
    <header class="chapter-header">
      <h2 class="chapter-header-title">Đăng nhập / Đăng ký</h2>
      <p class="chapter-header-subtitle">Quản lý tủ sách và tiến độ đọc (mockup)</p>
    </header>
    <div class="chapter-body auth-body">
      <form class="auth-form" onsubmit="return false;">
        <div class="auth-tabs">
          <button type="button" class="auth-tab auth-tab-active" data-mode="login">Đăng nhập</button>
          <button type="button" class="auth-tab" data-mode="register">Đăng ký</button>
        </div>
        <div class="auth-fields">
          <label>
            <span>Email</span>
            <input type="email" placeholder="ban@example.com" required />
          </label>
          <label>
            <span>Mật khẩu</span>
            <input type="password" placeholder="••••••••" required />
          </label>
          <label class="auth-field-confirm" style="display: none;">
            <span>Nhập lại mật khẩu</span>
            <input type="password" placeholder="••••••••" required />
          </label>
        </div>
        <button type="submit" class="auth-submit">Tiếp tục</button>
        <p class="auth-note">
          Đây là màn hình minh hoạ giao diện. Chức năng đăng nhập thực tế có thể được bổ sung sau.
        </p>
      </form>
    </div>
  `;

  // Gán sự kiện cho các nút đăng nhập/đăng ký
  const authTabs = chapterContentEl.querySelectorAll(".auth-tab");
  const confirmField = chapterContentEl.querySelector(".auth-field-confirm");
  
  authTabs.forEach((tab) => {
    tab.addEventListener("click", () => {
      authTabs.forEach((t) => t.classList.remove("auth-tab-active"));
      tab.classList.add("auth-tab-active");
      
      const mode = tab.getAttribute("data-mode");
      if (mode === "register") {
        confirmField.style.display = "flex";
      } else {
        confirmField.style.display = "none";
      }
    });
  });
}

function renderSettings() {
  currentView = "settings";
  setTocSidebar(false);
  setTocToggleVisible(false);
  setSidebarToggleVisible(false);
  const theme = getCurrentTheme();
  searchResultInfoEl.textContent = "Tuỳ chỉnh giao diện Historiart.";
  chapterContentEl.innerHTML = `
    <header class="chapter-header">
      <h2 class="chapter-header-title">Cài đặt</h2>
      <p class="chapter-header-subtitle">Giao diện & trải nghiệm đọc</p>
    </header>
    <div class="chapter-body settings-body">
      <section class="settings-section">
        <h3>Chế độ giao diện</h3>
        <p>Chọn kiểu hiển thị phù hợp với mắt bạn.</p>
        <div class="theme-toggle-group">
          <button type="button" class="theme-toggle-btn${
            theme === "dark" ? " theme-toggle-btn-active" : ""
          }" data-theme="dark">
            Tối
          </button>
          <button type="button" class="theme-toggle-btn${
            theme === "light" ? " theme-toggle-btn-active" : ""
          }" data-theme="light">
            Sáng
          </button>
        </div>
      </section>
    </div>
  `;

  const themeButtons = chapterContentEl.querySelectorAll(".theme-toggle-btn");
  themeButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const value = btn.getAttribute("data-theme");
      setTheme(value === "light" ? "light" : "dark");
      renderSettings();
    });
  });
}

function getCurrentTheme() {
  const stored = window.localStorage.getItem(THEME_STORAGE_KEY);
  if (stored === "light" || stored === "dark") return stored;
  return "light";
}

function applyTheme(theme) {
  const root = document.documentElement;
  if (theme === "light") {
    root.classList.add("theme-light");
  } else {
    root.classList.remove("theme-light");
  }
}

function setTheme(theme) {
  const normalized = theme === "light" ? "light" : "dark";
  window.localStorage.setItem(THEME_STORAGE_KEY, normalized);
  applyTheme(normalized);
}

function setTocSidebar(isOpen) {
  if (!tocSidebarEl) return;
  if (isOpen && currentView !== "book") {
    return;
  }
  if (isOpen) {
    tocSidebarEl.classList.add("open");
  } else {
    tocSidebarEl.classList.remove("open");
  }
}

function setSidebarToggleVisible(isVisible) {
  if (!sidebarToggleBtn) return;
  sidebarToggleBtn.style.display = isVisible ? "flex" : "none";
  if (!isVisible && tocSidebarEl) {
    setTocSidebar(false);
  }
}

function setTocToggleVisible(isVisible) {
  if (!tocToggleBtn) return;
  tocToggleBtn.style.display = isVisible ? "inline-flex" : "none";
}

function handleNavClick(view) {
  navItems.forEach((item) => {
    const itemView = item.getAttribute("data-view");
    if (itemView === view) {
      item.classList.add("nav-item-active");
    } else {
      item.classList.remove("nav-item-active");
    }
  });

  if (view !== "book") {
    setTocSidebar(false);
  }

  if (view === "home") {
    renderHome();
  } else if (view === "browse") {
    renderBrowse();
  } else if (view === "book") {
    renderBook();
  } else if (view === "auth") {
    renderAuth();
  } else if (view === "settings") {
    renderSettings();
  }
}

function attachMediaHandlers() {
  const buttons = chapterContentEl.querySelectorAll(".media-button");
  buttons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const chapterId = btn.getAttribute("data-chapter");
      const paragraphIndex = Number(btn.getAttribute("data-paragraph"));
      const chapter = book.chapters.find((c) => c.id === chapterId);
      if (!chapter) return;
      const media = chapter.mediaHints.find(
        (m) => m.paragraphIndex === paragraphIndex
      );
      if (!media) return;
      openVideo(media);
    });
  });
}

function attachImageHandlers() {
  const highlights = chapterContentEl.querySelectorAll(".highlight-image:not(.disabled)");
  highlights.forEach((highlight) => {
    highlight.style.cursor = "pointer";
    highlight.addEventListener("click", () => {
      // Check if disabled before processing
      if (highlight.classList.contains('disabled')) return;

      const hintIndex = Number(highlight.getAttribute("data-hint-index"));
      const chapterId = highlight.getAttribute("data-chapter-id");
      const chapter = book.chapters.find((c) => c.id === chapterId);
      if (!chapter || !chapter.imageHints || !chapter.imageHints[hintIndex]) return;

      const imageHint = chapter.imageHints[hintIndex];
      const title = imageHint.title || "Ảnh minh hoạ";
      const desc = imageHint.description || "";

      // Nếu có videoUrl, mở video overlay
      if (imageHint.videoUrl) {
        openVideo({ title, description: desc, url: imageHint.videoUrl });
      } else {
        // Nếu không có videoUrl, mở image overlay (có thể là ảnh hoặc text)
        openImage({ title, description: desc, imageUrl: imageHint.imageUrl || "", textContent: imageHint.textContent || "" });
      }
    });
  });
}

function applySearch(term) {
  currentSearchTerm = term;
  renderChapter();
}

function openVideo(media) {
  videoTitleEl.textContent = media.title || "Clip minh hoạ";
  videoDescEl.textContent =
    media.description ||
    "Video minh hoạ cho đoạn văn bạn đang đọc, giúp dễ hình dung hơn.";
  videoFrameEl.src = media.url || "";
  videoOverlayEl.classList.add("open");
  videoOverlayEl.setAttribute("aria-hidden", "false");
}

function closeVideo() {
  videoOverlayEl.classList.remove("open");
  videoOverlayEl.setAttribute("aria-hidden", "true");
  // Reset iframe to stop video playback
  videoFrameEl.src = "about:blank";
}

function openImage(imageData) {
  imageTitleEl.textContent = imageData.title || "Ảnh minh hoạ";
  imageDescEl.textContent = imageData.description || "";
  
  if (imageData.textContent) {
    // Hiển thị text content
    imageTextContentEl.textContent = imageData.textContent;
    imageTextContentEl.style.display = "block";
    imageContentEl.style.display = "none";
  } else if (imageData.imageUrl) {
    // Hiển thị ảnh
    imageContentEl.src = imageData.imageUrl;
    imageContentEl.style.display = "block";
    imageTextContentEl.style.display = "none";
  } else {
    imageContentEl.style.display = "none";
    imageTextContentEl.style.display = "none";
  }
  
  imageOverlayEl.classList.add("open");
  imageOverlayEl.setAttribute("aria-hidden", "false");
}

function closeImage() {
  imageOverlayEl.classList.remove("open");
  imageOverlayEl.setAttribute("aria-hidden", "true");
  imageContentEl.src = "";
  imageTextContentEl.textContent = "";
  imageTextContentEl.style.display = "none";
}

if (searchInput) {
  searchInput.addEventListener("input", (e) => {
    applySearch(e.target.value || "");
  });
}

if (closeVideoBtn) {
  closeVideoBtn.addEventListener("click", () => {
    closeVideo();
  });
}

if (videoOverlayEl) {
  videoOverlayEl.addEventListener("click", (e) => {
    if (e.target === videoOverlayEl || e.target.classList.contains("overlay-backdrop")) {
      closeVideo();
    }
  });
}

if (closeImageBtn) {
  closeImageBtn.addEventListener("click", () => {
    closeImage();
  });
}

if (imageOverlayEl) {
  imageOverlayEl.addEventListener("click", (e) => {
    if (e.target === imageOverlayEl || e.target.classList.contains("overlay-backdrop")) {
      closeImage();
    }
  });
}

document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    if (videoOverlayEl.classList.contains("open")) {
      closeVideo();
    }
    if (imageOverlayEl.classList.contains("open")) {
      closeImage();
    }
  }
});

if (tocToggleBtn) {
  tocToggleBtn.addEventListener("click", () => {
    if (!tocSidebarEl) return;
    const isOpen = tocSidebarEl.classList.contains("open");
    setTocSidebar(!isOpen);
  });
}

if (sidebarToggleBtn) {
  sidebarToggleBtn.addEventListener("click", () => {
    if (!tocSidebarEl) return;
    // Chỉ cho phép mở sidebar khi đang đọc sách
    if (currentView !== "book") {
      return;
    }
    renderSidebarItems(); // Đảm bảo items được render khi mở sidebar
    attachSidebarToggleHandlers(); // Đảm bảo toggle handlers được gán
    setTocSidebar(true);
  });
}

if (sidebarCloseBtn) {
  sidebarCloseBtn.addEventListener("click", () => {
    if (!tocSidebarEl) return;
    setTocSidebar(false);
  });
}

if (saveNoteBtn) {
  saveNoteBtn.addEventListener("click", saveNote);
}

if (cancelNoteBtn) {
  cancelNoteBtn.addEventListener("click", closeNoteDialog);
}

if (closeNoteBtn) {
  closeNoteBtn.addEventListener("click", closeNoteDialog);
}

if (noteDialog) {
  noteDialog.addEventListener("click", (e) => {
    if (e.target === noteDialog || e.target.classList.contains("overlay-backdrop")) {
      closeNoteDialog();
    }
  });
}

if (addSidebarNoteBtn && sidebarNoteInput) {
  addSidebarNoteBtn.addEventListener("click", () => {
    const noteText = sidebarNoteInput.value.trim();
    if (!noteText) {
      alert("Vui lòng nhập nội dung note");
      return;
    }
    
    const chapter = book.chapters.find((c) => c.id === currentChapterId);
    if (!chapter) return;
    
    const note = {
      id: Date.now().toString(),
      chapterId: currentChapterId,
      text: "Note trực tiếp",
      fullText: "Note trực tiếp",
      note: noteText,
      timestamp: new Date().toISOString(),
    };
    
    notes.push(note);
    localStorage.setItem(NOTES_STORAGE_KEY, JSON.stringify(notes));
    
    sidebarNoteInput.value = "";
    renderSidebarItems();
  });
  
  sidebarNoteInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      addSidebarNoteBtn.click();
    }
  });
}

function attachSidebarToggleHandlers() {
  const toggles = document.querySelectorAll(".sidebar-section-toggle");
  toggles.forEach((toggle) => {
    const newToggle = toggle.cloneNode(true);
    toggle.parentNode.replaceChild(newToggle, toggle);
    
    newToggle.addEventListener("click", () => {
      const section = newToggle.closest(".sidebar-section");
      const isActive = section.classList.contains("active");
      
      if (isActive) {
        section.classList.remove("active");
      } else {
        section.classList.add("active");
      }
    });
  });
}

if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", attachSidebarToggleHandlers);
} else {
  attachSidebarToggleHandlers();
}

document.addEventListener("click", (e) => {
  if (!tocSidebarEl || !tocSidebarEl.classList.contains("open")) return;
  if (currentView !== "book") {
    setTocSidebar(false);
    return;
  }
  
  if (tocSidebarEl.contains(e.target) || sidebarToggleBtn?.contains(e.target)) {
    return;
  }
  
  setTocSidebar(false);
});

navItems.forEach((item) => {
  item.addEventListener("click", () => {
    const view = item.getAttribute("data-view");
    handleNavClick(view);
  });
});

function attachTextSelectionHandlers() {
  if (!chapterContentEl || currentView !== "book") return;

  // Desktop: mouse events
  chapterContentEl.addEventListener("mouseup", handleTextSelection);

// Mobile: touch and selection events
chapterContentEl.addEventListener("touchend", handleTextSelection);
document.addEventListener("selectionchange", handleSelectionChange);

// Mobile: long press detection
let longPressTimer;
chapterContentEl.addEventListener("touchstart", (e) => {
  longPressTimer = setTimeout(() => {
    // Long press detected, handle selection
    handleTextSelection(e);
  }, 500);
});

chapterContentEl.addEventListener("touchend", () => {
  clearTimeout(longPressTimer);
});

chapterContentEl.addEventListener("touchmove", () => {
  clearTimeout(longPressTimer);
});

  // Prevent default context menu on chapter content
  chapterContentEl.addEventListener("contextmenu", (e) => {
    e.preventDefault();
    return false;
  });

  document.addEventListener("click", (e) => {
    if (textContextMenu && !textContextMenu.contains(e.target) && !textContextMenu.classList.contains("hidden")) {
      hideContextMenu();
    }
  });

  const contextMenuItems = textContextMenu?.querySelectorAll(".context-menu-item");
  contextMenuItems?.forEach((item) => {
    item.addEventListener("click", (e) => {
      const action = e.target.getAttribute("data-action");
      handleContextMenuAction(action);
    });
  });
}

function handleTextSelection(e) {
  if (currentView !== "book") return;

  // Use requestAnimationFrame for better performance instead of setTimeout
  requestAnimationFrame(() => {
    const selection = window.getSelection();
    const text = selection.toString().trim();

    if (text.length === 0) {
      hideContextMenu();
      return;
    }

    const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
    if (range) {
      const container = range.commonAncestorContainer;
      const parent = container.nodeType === 3 ? container.parentElement : container;
      if (parent.closest('.user-highlight')) {
        return;
      }
    }

    if (selection.rangeCount > 0) {
      selectedRange = selection.getRangeAt(0).cloneRange();
      selectedText = text;

      const rect = selection.getRangeAt(0).getBoundingClientRect();
      showContextMenu(rect.left + rect.width / 2, rect.top - 10);
    }
  });
}

function handleSelectionChange() {
  if (currentView !== "book") return;

  requestAnimationFrame(() => {
    const selection = window.getSelection();
    const text = selection.toString().trim();

    if (text.length === 0) {
      hideContextMenu();
      return;
    }

    const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
    if (range) {
      const container = range.commonAncestorContainer;
      const parent = container.nodeType === 3 ? container.parentElement : container;
      if (parent.closest('.user-highlight')) {
        return;
      }
    }

    if (selection.rangeCount > 0) {
      selectedRange = selection.getRangeAt(0).cloneRange();
      selectedText = text;

      const rect = selection.getRangeAt(0).getBoundingClientRect();
      // Show context menu at the center of selection for mobile
      showContextMenu(rect.left + rect.width / 2, rect.top + rect.height / 2);
    }
  });
}

function showContextMenu(x, y) {
  if (!textContextMenu) return;

  // Ensure menu stays within viewport bounds
  const menuRect = textContextMenu.getBoundingClientRect();
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;

  let finalX = x;
  let finalY = y;

  // Adjust horizontal position
  if (x + menuRect.width > viewportWidth) {
    finalX = viewportWidth - menuRect.width - 10;
  }
  if (finalX < 10) {
    finalX = 10;
  }

  // Adjust vertical position
  if (y + menuRect.height > viewportHeight) {
    finalY = y - menuRect.height - 10;
  }
  if (finalY < 10) {
    finalY = 10;
  }

  textContextMenu.style.left = `${finalX}px`;
  textContextMenu.style.top = `${finalY}px`;
  textContextMenu.classList.remove("hidden");
  textContextMenu.setAttribute("aria-hidden", "false");
}

function hideContextMenu() {
  if (!textContextMenu) return;
  textContextMenu.classList.add("hidden");
  textContextMenu.setAttribute("aria-hidden", "true");
}

function handleContextMenuAction(action) {
  if (!selectedRange || !selectedText) return;
  
  const chapter = book.chapters.find((c) => c.id === currentChapterId);
  if (!chapter) return;
  
  const text = selectedText;
  const id = Date.now().toString();
  const item = {
    id,
    chapterId: currentChapterId,
    text: text.substring(0, 100) + (text.length > 100 ? "..." : ""),
    fullText: text,
    timestamp: new Date().toISOString(),
  };
  
  if (action === "highlight") {
    createHighlight(item);
  } else if (action === "bookmark") {
    createBookmark(item);
  } else if (action === "note") {
    showNoteDialog(item);
  }
  
  hideContextMenu();
  selectedRange = null;
  selectedText = null;
  window.getSelection().removeAllRanges();
}

function createHighlight(item) {
  highlights.push(item);
  localStorage.setItem(HIGHLIGHTS_STORAGE_KEY, JSON.stringify(highlights));
  
  renderChapter();
  renderSidebarItems();
}

function createBookmark(item) {
  bookmarks.push(item);
  localStorage.setItem(BOOKMARKS_STORAGE_KEY, JSON.stringify(bookmarks));
  renderSidebarItems();
}

function showNoteDialog(item) {
  if (!noteDialog || !noteSelectedTextEl) return;
  noteSelectedTextEl.textContent = `"${item.fullText}"`;
  noteTextInput.value = "";
  noteDialog.classList.remove("hidden");
  noteDialog.setAttribute("aria-hidden", "false");
  
  noteDialog.dataset.tempItem = JSON.stringify(item);
}

function saveNote() {
  if (!noteDialog || !noteTextInput) return;
  
  const noteText = noteTextInput.value.trim();
  if (!noteText) return;
  
  const tempItem = JSON.parse(noteDialog.dataset.tempItem || "{}");
  const note = {
    ...tempItem,
    note: noteText,
  };
  
  notes.push(note);
  localStorage.setItem(NOTES_STORAGE_KEY, JSON.stringify(notes));
  
  closeNoteDialog();
  renderSidebarItems();
}

function closeNoteDialog() {
  if (!noteDialog) return;
  noteDialog.classList.add("hidden");
  noteDialog.setAttribute("aria-hidden", "true");
  noteTextInput.value = "";
  noteDialog.dataset.tempItem = "";
}


function renderSidebarItems() {
  if (!highlightsListEl || !bookmarksListEl || !notesListEl) return;
  
  attachClearAllHandlers();
  
  const currentChapterHighlights = highlights.filter((h) => h.chapterId === currentChapterId);
  if (currentChapterHighlights.length === 0) {
    highlightsListEl.innerHTML = '<p class="sidebar-empty">Chưa có highlight nào trong chương này</p>';
  } else {
    highlightsListEl.innerHTML = currentChapterHighlights
      .map(
        (h) => `
      <div class="sidebar-item" data-id="${h.id}">
        <div class="sidebar-item-text">${h.text}</div>
        <button class="sidebar-item-delete" data-type="highlight" data-id="${h.id}" aria-label="Xóa">✕</button>
      </div>
    `
      )
      .join("");
  }
  
  const currentChapterBookmarks = bookmarks.filter((b) => b.chapterId === currentChapterId);
  if (currentChapterBookmarks.length === 0) {
    bookmarksListEl.innerHTML = '<p class="sidebar-empty">Chưa có bookmark nào trong chương này</p>';
  } else {
    bookmarksListEl.innerHTML = currentChapterBookmarks
      .map(
        (b) => `
      <div class="sidebar-item" data-id="${b.id}">
        <div class="sidebar-item-text">${b.text}</div>
        <button class="sidebar-item-delete" data-type="bookmark" data-id="${b.id}" aria-label="Xóa">✕</button>
      </div>
    `
      )
      .join("");
  }
  
  const currentChapterNotes = notes.filter((n) => n.chapterId === currentChapterId);
  if (currentChapterNotes.length === 0) {
    notesListEl.innerHTML = '<p class="sidebar-empty">Chưa có note nào trong chương này</p>';
  } else {
    notesListEl.innerHTML = currentChapterNotes
      .map(
        (n) => `
      <div class="sidebar-item sidebar-item-note" data-id="${n.id}">
        <div class="sidebar-item-text">${n.text || "Note trực tiếp"}</div>
        <div class="sidebar-item-note-text">${n.note}</div>
        <button class="sidebar-item-delete" data-type="note" data-id="${n.id}" aria-label="Xóa">✕</button>
      </div>
    `
      )
      .join("");
  }
  
  attachDeleteHandlers();
  attachSidebarToggleHandlers();
}

function attachDeleteHandlers() {
  const deleteButtons = document.querySelectorAll(".sidebar-item-delete");
  deleteButtons.forEach((btn) => {
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      const type = btn.getAttribute("data-type");
      const id = btn.getAttribute("data-id");
      deleteItem(type, id);
    });
  });
}

function attachClearAllHandlers() {
  const clearButtons = document.querySelectorAll(".sidebar-clear-btn");
  clearButtons.forEach((btn) => {
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      const type = btn.getAttribute("data-type");

      // Prevent multiple confirm dialogs
      if (isConfirmDialogOpen) {
        return;
      }

      isConfirmDialogOpen = true;
      const confirmed = confirm(`Bạn có chắc muốn xóa tất cả ${type === "highlight" ? "highlights" : type === "bookmark" ? "bookmarks" : "notes"}?`);

      if (confirmed) {
        clearAllItems(type);
      }

      // Reset flag after a short delay to allow for dialog animation
      setTimeout(() => {
        isConfirmDialogOpen = false;
      }, 100);
    });
  });
}

function clearAllItems(type) {
  if (type === "highlight") {
    highlights = highlights.filter((h) => h.chapterId !== currentChapterId);
    localStorage.setItem(HIGHLIGHTS_STORAGE_KEY, JSON.stringify(highlights));
  } else if (type === "bookmark") {
    bookmarks = bookmarks.filter((b) => b.chapterId !== currentChapterId);
    localStorage.setItem(BOOKMARKS_STORAGE_KEY, JSON.stringify(bookmarks));
  } else if (type === "note") {
    notes = notes.filter((n) => n.chapterId !== currentChapterId);
    localStorage.setItem(NOTES_STORAGE_KEY, JSON.stringify(notes));
  }
  
  renderSidebarItems();
  renderChapter();
}

function deleteItem(type, id) {
  if (type === "highlight") {
    highlights = highlights.filter((h) => h.id !== id);
    localStorage.setItem(HIGHLIGHTS_STORAGE_KEY, JSON.stringify(highlights));
  } else if (type === "bookmark") {
    bookmarks = bookmarks.filter((b) => b.id !== id);
    localStorage.setItem(BOOKMARKS_STORAGE_KEY, JSON.stringify(bookmarks));
  } else if (type === "note") {
    notes = notes.filter((n) => n.id !== id);
    localStorage.setItem(NOTES_STORAGE_KEY, JSON.stringify(notes));
  }
  
  renderSidebarItems();
  renderChapter();
}

function ensureSidebarClosed() {
  setTocSidebar(false);
  
  const sidebarSections = document.querySelectorAll(".sidebar-section");
  sidebarSections.forEach((section) => {
    section.classList.remove("active");
  });
  
  if (textContextMenu) {
    textContextMenu.classList.add("hidden");
    textContextMenu.setAttribute("aria-hidden", "true");
  }
  
  if (noteDialog) {
    noteDialog.classList.add("hidden");
    noteDialog.setAttribute("aria-hidden", "true");
    if (noteTextInput) {
      noteTextInput.value = "";
    }
    if (noteDialog.dataset) {
      noteDialog.dataset.tempItem = "";
    }
  }
  
  if (videoOverlayEl) {
    videoOverlayEl.classList.remove("open");
    videoOverlayEl.setAttribute("aria-hidden", "true");
  }
  if (imageOverlayEl) {
    imageOverlayEl.classList.remove("open");
    imageOverlayEl.setAttribute("aria-hidden", "true");
  }
}

// Display settings functions
function getDefaultDisplaySettings() {
  return {
    contextNotes: true,
    mediaHints: true
  };
}

function getDisplaySettings() {
  try {
    const stored = window.localStorage.getItem(DISPLAY_SETTINGS_KEY);
    if (stored) {
      return { ...getDefaultDisplaySettings(), ...JSON.parse(stored) };
    }
  } catch (e) {
    console.warn("Failed to load display settings:", e);
  }
  return getDefaultDisplaySettings();
}

function saveDisplaySettings(settings) {
  try {
    window.localStorage.setItem(DISPLAY_SETTINGS_KEY, JSON.stringify(settings));
  } catch (e) {
    console.warn("Failed to save display settings:", e);
  }
}

function applyDisplaySettings() {
  const settings = getDisplaySettings();

  // Update checkboxes
  if (toggleContextNotesEl) {
    toggleContextNotesEl.checked = settings.contextNotes;
  }
  if (toggleMediaHintsEl) {
    toggleMediaHintsEl.checked = settings.mediaHints;
  }

  // Apply highlight state - if contextNotes is true, enable highlights; if false, disable highlights
  document.querySelectorAll('.context-note').forEach(el => {
    el.classList.toggle('disabled', !settings.contextNotes);
  });

  document.querySelectorAll('.highlight-image').forEach(el => {
    el.classList.toggle('disabled', !settings.contextNotes);
  });

  // Media hints visibility
  document.querySelectorAll('.media-hint').forEach(el => {
    el.classList.toggle('hidden', !settings.mediaHints);
  });
}

function initDisplaySettings() {
  if (toggleContextNotesEl) {
    toggleContextNotesEl.addEventListener('change', () => {
      const settings = getDisplaySettings();
      settings.contextNotes = toggleContextNotesEl.checked;
      saveDisplaySettings(settings);
      applyDisplaySettings();
    });
  }

  if (toggleMediaHintsEl) {
    toggleMediaHintsEl.addEventListener('change', () => {
      const settings = getDisplaySettings();
      settings.mediaHints = toggleMediaHintsEl.checked;
      saveDisplaySettings(settings);
      applyDisplaySettings();
    });
  }

  applyDisplaySettings();
}

applyTheme(getCurrentTheme());
setSidebarToggleVisible(false);
initDisplaySettings();

if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", ensureSidebarClosed);
} else {
  ensureSidebarClosed();
}

renderHome();

setTimeout(ensureSidebarClosed, 100);

